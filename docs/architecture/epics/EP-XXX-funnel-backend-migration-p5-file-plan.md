# EP-XXX: Funnel Backend Migration - Technical Specification (P5)

**Initiative**: [IN-032](../../../initiatives/IN-032-funnel-supabase-to-backend-migration.md)  
**Status**: P5 - Technical Specification  
**Created**: 2026-01-28  
**Last Updated**: 2026-01-28

---

## File Plan

### Files to Create

#### 1. Database Schema Files

**File**: `libs/data/src/schema/funnel-sessions.schema.ts`
- **Purpose**: Drizzle schema for `funnel_sessions` table
- **Lines**: ~30
- **Dependencies**: `drizzle-orm/pg-core`

**File**: `libs/data/src/schema/funnel-options.schema.ts`
- **Purpose**: Drizzle schema for `funnel_options` table
- **Lines**: ~40
- **Dependencies**: `drizzle-orm/pg-core`, `funnel-sessions.schema.ts`

**File**: `libs/data/src/schema/index.ts` (UPDATE)
- **Purpose**: Export funnel schemas
- **Changes**: Add exports for `funnelSessions`, `funnelOptions`

#### 2. Type Definitions

**File**: `libs/shared/src/types/funnel.ts`
- **Purpose**: TypeScript types for funnel data
- **Lines**: ~50
- **Exports**: `FunnelSession`, `FunnelOption`, `CreateSessionData`, `UpdateSessionData`

#### 3. Business Services

**File**: `libs/business/src/services/funnel-session.service.ts`
- **Purpose**: Business logic for session operations
- **Lines**: ~150
- **Dependencies**: `@ryla/data`, `@ryla/shared`

**File**: `libs/business/src/services/funnel-option.service.ts`
- **Purpose**: Business logic for option operations
- **Lines**: ~120
- **Dependencies**: `@ryla/data`, `@ryla/shared`

**File**: `libs/business/src/services/index.ts` (UPDATE)
- **Purpose**: Export services
- **Changes**: Add exports for funnel services

#### 4. tRPC Router

**File**: `libs/trpc/src/routers/funnel.router.ts`
- **Purpose**: tRPC router with all funnel procedures
- **Lines**: ~200
- **Dependencies**: `@ryla/business`, `@ryla/shared`, `zod`, `@trpc/server`

**File**: `libs/trpc/src/routers/index.ts` (UPDATE)
- **Purpose**: Export all routers
- **Changes**: Add export for `funnelRouter`

#### 5. Database Migration

**File**: `drizzle/migrations/XXXXXX_create_funnel_tables.sql` (GENERATED)
- **Purpose**: Database migration script
- **Generated by**: Drizzle Kit
- **Contains**: CREATE TABLE statements for `funnel_sessions` and `funnel_options`

#### 6. Frontend Updates

**File**: `apps/funnel/services/session-service.ts` (UPDATE)
- **Purpose**: Update to use backend API instead of Supabase
- **Changes**: Replace Supabase calls with API calls
- **Lines**: ~330 (current) → ~300 (updated, remove Supabase code)

**File**: `apps/funnel/lib/trpc-client.ts` (CREATE or UPDATE)
- **Purpose**: tRPC client setup for funnel app
- **Lines**: ~50
- **Dependencies**: `@trpc/client`, `@trpc/react-query`

#### 7. Tests

**File**: `libs/business/src/services/funnel-session.service.spec.ts`
- **Purpose**: Unit tests for session service
- **Lines**: ~200

**File**: `libs/business/src/services/funnel-option.service.spec.ts`
- **Purpose**: Unit tests for option service
- **Lines**: ~150

**File**: `libs/trpc/src/routers/funnel.router.spec.ts`
- **Purpose**: Integration tests for funnel router
- **Lines**: ~250

**File**: `apps/funnel/services/session-service.spec.ts` (UPDATE)
- **Purpose**: Update tests to use backend API mocks
- **Changes**: Replace Supabase mocks with API mocks

---

### Files to Update

#### 1. Package Dependencies

**File**: `apps/funnel/package.json`
- **Remove**: `@supabase/ssr`
- **Add**: `@trpc/client`, `@trpc/react-query` (if not already present)

#### 2. Environment Variables

**File**: `apps/funnel/.env.example`
- **Remove**: `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `NEXT_PUBLIC_ENABLE_DEV_SUPABASE`, `NEXT_PUBLIC_DEBUG_SUPABASE`
- **Add**: `NEXT_PUBLIC_API_BASE_URL` (if not already present)

#### 3. Documentation

**File**: `apps/funnel/docs/SUPABASE_SETUP.md` (DELETE or UPDATE)
- **Action**: Delete or update to reflect backend API usage

**File**: `apps/funnel/README.md` (UPDATE)
- **Changes**: Remove Supabase references, add backend API documentation

---

### Files to Delete

**Directory**: `apps/funnel/utils/supabase/`
- **Files**: `client.ts`, `server.ts`
- **Action**: Delete entire directory

---

## Task Breakdown

### Phase 1: Backend Infrastructure (P6)

#### Task 1.1: Create Database Schema
**Estimated Time**: 1 hour

1. Create `libs/data/src/schema/funnel-sessions.schema.ts`
   - Define `funnelSessions` table with all fields
   - Add indexes
   - Export schema

2. Create `libs/data/src/schema/funnel-options.schema.ts`
   - Define `funnelOptions` table with all fields
   - Add foreign key to `funnelSessions`
   - Add unique constraint on `(sessionId, optionKey)`
   - Add indexes
   - Export schema

3. Update `libs/data/src/schema/index.ts`
   - Export `funnelSessions` and `funnelOptions`

**Acceptance Criteria**:
- [ ] Schema files created
- [ ] All fields match Supabase structure
- [ ] Indexes created for performance
- [ ] Foreign keys properly defined
- [ ] Exports added to index.ts

#### Task 1.2: Create Database Migration
**Estimated Time**: 30 minutes

1. Generate migration using Drizzle Kit
   ```bash
   pnpm nx drizzle-kit generate --name create_funnel_tables
   ```

2. Review generated migration SQL
   - Verify table structure
   - Verify indexes
   - Verify constraints

3. Test migration in development database
   ```bash
   pnpm nx drizzle-kit push
   ```

**Acceptance Criteria**:
- [ ] Migration script generated
- [ ] Migration tested in development
- [ ] Tables created successfully
- [ ] Indexes created successfully

#### Task 1.3: Create Type Definitions
**Estimated Time**: 30 minutes

1. Create `libs/shared/src/types/funnel.ts`
   - Define `FunnelSession` interface
   - Define `FunnelOption` interface
   - Define `CreateSessionData` interface
   - Define `UpdateSessionData` interface
   - Export all types

**Acceptance Criteria**:
- [ ] Type file created
- [ ] All types match Supabase structure
- [ ] Types exported properly

#### Task 1.4: Create Business Services
**Estimated Time**: 3 hours

1. Create `libs/business/src/services/funnel-session.service.ts`
   - Implement `createSession` method
   - Implement `updateSession` method
   - Implement `getSession` method
   - Add error handling
   - Add input validation

2. Create `libs/business/src/services/funnel-option.service.ts`
   - Implement `saveOption` method
   - Implement `saveAllOptions` method
   - Implement `getSessionOptions` method
   - Add error handling
   - Add input validation

3. Update `libs/business/src/services/index.ts`
   - Export funnel services

**Acceptance Criteria**:
- [ ] Service files created
- [ ] All methods implemented
- [ ] Error handling added
- [ ] Input validation added
- [ ] Services exported

#### Task 1.5: Create tRPC Router
**Estimated Time**: 2 hours

1. Create `libs/trpc/src/routers/funnel.router.ts`
   - Implement `createSession` procedure
   - Implement `updateSession` procedure
   - Implement `getSession` procedure
   - Implement `saveOption` procedure
   - Implement `saveAllOptions` procedure
   - Implement `getSessionOptions` procedure
   - Add Zod input validation
   - Use `publicProcedure` (no auth required)

2. Update `libs/trpc/src/routers/index.ts`
   - Export `funnelRouter`

3. Update main router (if needed)
   - Add `funnelRouter` to app router

**Acceptance Criteria**:
- [ ] Router file created
- [ ] All procedures implemented
- [ ] Input validation with Zod
- [ ] Router exported and registered
- [ ] All procedures use `publicProcedure`

---

### Phase 2: Frontend Migration (P6)

#### Task 2.1: Setup tRPC Client
**Estimated Time**: 1 hour

1. Create or update `apps/funnel/lib/trpc-client.ts`
   - Setup tRPC client
   - Configure API base URL
   - Export client

2. Update `apps/funnel/package.json`
   - Add `@trpc/client`, `@trpc/react-query` if needed

**Acceptance Criteria**:
- [ ] tRPC client configured
- [ ] Dependencies added
- [ ] Client exported

#### Task 2.2: Update Session Service
**Estimated Time**: 3 hours

1. Update `apps/funnel/services/session-service.ts`
   - Remove Supabase imports
   - Add tRPC client import
   - Replace `createSession` to use tRPC
   - Replace `updateSession` to use tRPC
   - Replace `saveOption` to use tRPC
   - Replace `saveAllOptions` to use tRPC
   - Replace `getSessionOptions` to use tRPC
   - Maintain same function signatures
   - Maintain same return types
   - Keep session ID generation logic
   - Keep development mode behavior

**Acceptance Criteria**:
- [ ] All Supabase calls replaced
- [ ] All functions use tRPC
- [ ] Function signatures unchanged
- [ ] Return types unchanged
- [ ] Session ID logic preserved
- [ ] Development mode preserved

#### Task 2.3: Remove Supabase Dependencies
**Estimated Time**: 30 minutes

1. Delete `apps/funnel/utils/supabase/` directory
2. Remove `@supabase/ssr` from `package.json`
3. Remove Supabase environment variables from `.env.example`
4. Update `apps/funnel/README.md` to remove Supabase references

**Acceptance Criteria**:
- [ ] Supabase directory deleted
- [ ] Package removed
- [ ] Environment variables removed
- [ ] Documentation updated

---

### Phase 3: Testing (P7)

#### Task 3.1: Unit Tests - Services
**Estimated Time**: 2 hours

1. Create `libs/business/src/services/funnel-session.service.spec.ts`
   - Test `createSession`
   - Test `updateSession`
   - Test `getSession`
   - Test error handling

2. Create `libs/business/src/services/funnel-option.service.spec.ts`
   - Test `saveOption`
   - Test `saveAllOptions`
   - Test `getSessionOptions`
   - Test error handling

**Acceptance Criteria**:
- [ ] Test files created
- [ ] All methods tested
- [ ] Error cases tested
- [ ] Tests passing

#### Task 3.2: Integration Tests - Router
**Estimated Time**: 2 hours

1. Create `libs/trpc/src/routers/funnel.router.spec.ts`
   - Test all procedures
   - Test input validation
   - Test error handling
   - Test anonymous access

**Acceptance Criteria**:
- [ ] Test file created
- [ ] All procedures tested
- [ ] Validation tested
- [ ] Tests passing

#### Task 3.3: Update Frontend Tests
**Estimated Time**: 1 hour

1. Update `apps/funnel/services/session-service.spec.ts`
   - Replace Supabase mocks with API mocks
   - Update test expectations
   - Ensure all tests pass

**Acceptance Criteria**:
- [ ] Tests updated
- [ ] Mocks replaced
- [ ] All tests passing

---

### Phase 4: Integration & Deployment (P8-P9)

#### Task 4.1: End-to-End Testing
**Estimated Time**: 2 hours

1. Test complete funnel flow
   - Create session
   - Save options
   - Update session
   - Retrieve options
   - Verify data persistence

2. Test error scenarios
   - Invalid session IDs
   - Network errors
   - Database errors

**Acceptance Criteria**:
- [ ] Complete flow tested
- [ ] Error scenarios tested
- [ ] All tests passing

#### Task 4.2: Data Migration (if needed)
**Estimated Time**: 2 hours (if production data exists)

1. Export data from Supabase
2. Transform data format (if needed)
3. Import data to main database
4. Validate data integrity
5. Test with migrated data

**Acceptance Criteria**:
- [ ] Data exported
- [ ] Data imported
- [ ] Data validated
- [ ] No data loss

#### Task 4.3: Deployment
**Estimated Time**: 1 hour

1. Deploy backend changes
2. Deploy frontend changes
3. Verify deployment
4. Monitor for errors

**Acceptance Criteria**:
- [ ] Backend deployed
- [ ] Frontend deployed
- [ ] No errors in production
- [ ] Monitoring confirms success

---

## Implementation Order

### Step 1: Backend Foundation
1. Database schema (Task 1.1)
2. Migration (Task 1.2)
3. Types (Task 1.3)
4. Services (Task 1.4)
5. Router (Task 1.5)

### Step 2: Frontend Migration
1. tRPC client setup (Task 2.1)
2. Update session service (Task 2.2)
3. Remove Supabase (Task 2.3)

### Step 3: Testing
1. Service tests (Task 3.1)
2. Router tests (Task 3.2)
3. Frontend tests (Task 3.3)

### Step 4: Integration
1. E2E testing (Task 4.1)
2. Data migration (Task 4.2, if needed)
3. Deployment (Task 4.3)

---

## Dependencies

### External Dependencies
- **Drizzle ORM**: Already in use
- **tRPC**: Already in use
- **Zod**: Already in use

### Internal Dependencies
- **Database**: Postgres access (✅ exists)
- **tRPC Infrastructure**: Router setup (✅ exists)
- **Business Layer**: Service patterns (✅ exists)

---

## Risk Mitigation

### Risk: Breaking Changes
**Mitigation**: Maintain exact function signatures and return types

### Risk: Performance Degradation
**Mitigation**: Add database indexes, optimize queries, load test

### Risk: Data Loss
**Mitigation**: Comprehensive testing, backup before migration, validate data integrity

### Risk: Anonymous Session Support
**Mitigation**: Use `publicProcedure`, test thoroughly, document behavior

---

## Success Metrics

- [ ] All Supabase operations replaced
- [ ] Zero Supabase dependencies
- [ ] All tests passing
- [ ] Performance maintained (< 100ms)
- [ ] Zero data loss
- [ ] Deployment successful

---

**Next Phase**: P6 - Implementation

**Estimated Total Time**: ~20 hours
