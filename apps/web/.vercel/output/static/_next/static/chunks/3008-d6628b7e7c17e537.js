"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3008],{34195:function(e,t,r){r.d(t,{Jx:function(){return h},WL:function(){return c},_L:function(){return w},uy:function(){return u}});var a=r(42063);let o=r(72164).env.NEXT_PUBLIC_API_URL||"http://localhost:3001";function i(e,t){return Array.isArray(e.messages)&&e.messages.length>0?e.messages[0]:e.message?e.message:"string"==typeof e.messages?e.messages:t}async function n(e){try{let t=await (0,a.SH)(`${o}/characters/generate-base-images`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let e=await t.json().catch(()=>({}));throw Error(i(e,"Failed to start image generation"))}return t.json()}catch(r){let e=r instanceof Error?r:Error(String(r)),t=e.message||String(r);if(t.includes("Failed to fetch")||t.includes("NetworkError")||t.includes("ERR_CONNECTION_REFUSED")||t.includes("ERR_NETWORK")||"TypeError"===e.name)throw Error(`ERR_CONNECTION_REFUSED: Unable to connect to server at ${o}`);throw e}}async function s(e,t){let r=t&&t.length>1?`${o}/characters/base-images/${e}?allJobIds=${t.join(",")}`:`${o}/characters/base-images/${e}`,n=await (0,a.SH)(r);if(!n.ok)throw Error(i(await n.json().catch(()=>({})),"Failed to get job results"));return n.json()}async function l(e,t,r){let a=Date.now();for(;Date.now()-a<3e5;){let a=await t(e);if(r&&r(a.status),"completed"===a.status||"partial"===a.status){if(a.images&&a.images.length>0){if("partial"===a.status&&a.images.length>=3)return{...a,status:"completed"};if("completed"===a.status)return a}"partial"!==a.status||a.images&&a.images.length}if("failed"===a.status)throw Error(a.error||"Job failed");await new Promise(e=>setTimeout(e,2e3))}throw Error("Job timed out")}async function c(e){try{let t=await (0,a.SH)(`${o}/characters/base-images/${e}`);if(!t.ok){let e=await t.json().catch(()=>({}));throw Error(i(e,"Failed to get base image job result"))}return t.json()}catch(r){let e=r instanceof Error?r:Error(String(r)),t=e.message||String(r);if(t.includes("Failed to fetch")||t.includes("NetworkError")||t.includes("ERR_CONNECTION_REFUSED")||t.includes("ERR_NETWORK")||"TypeError"===e.name)throw Error(`ERR_CONNECTION_REFUSED: Unable to connect to server at ${o}`);throw e}}async function u(e,t,r){let{jobId:a,allJobIds:o}=await n(e);if(o&&o.length>1)return f(o,t,r);let i=await l(a,e=>s(e,o),t);if(!i.images||0===i.images.length)throw Error("No images generated");return i.images}async function f(e,t,r){let a=[],o=new Set(e),i=Date.now();for(;o.size>0&&Date.now()-i<6e5;){let i=Array.from(o).map(async e=>{try{let t=await c(e);return{jobId:e,result:t}}catch(t){return console.error(`Failed to poll job ${e}:`,t),{jobId:e,result:null}}}),n=await Promise.all(i);for(let t=0;t<n.length;t++){let{jobId:i,result:s}=n[t];if(s){if("completed"===s.status&&s.images&&s.images.length>0){let t=e.indexOf(i);s.images.forEach(e=>{a.push(e),r&&r(e,t)}),o.delete(i)}else if("failed"===s.status){let t=e.indexOf(i);r&&r({id:`failed-${i}`,url:"failed",thumbnailUrl:"failed",error:s.error||"Generation failed"},t),o.delete(i)}else if("in_progress"===s.status||"queued"===s.status)continue}}t&&t(a.length===e.length?"completed":"in_progress"),o.size>0&&await new Promise(e=>setTimeout(e,2e3))}return o.size>0&&console.warn(`Some base image jobs timed out: ${Array.from(o).join(", ")}`),a}async function d(e){let t=await (0,a.SH)(`${o}/characters/generate-profile-picture-set`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw Error(i(await t.json().catch(()=>({})),"Failed to start profile picture set generation"));return t.json()}async function g(e,t){let r=t&&t.length>1?`${o}/characters/profile-picture-set/${e}?allJobIds=${t.join(",")}`:`${o}/characters/profile-picture-set/${e}`,n=await (0,a.SH)(r);if(!n.ok)throw Error(i(await n.json().catch(()=>({})),"Failed to get profile picture set results"));return n.json()}async function m(e){let t=await (0,a.SH)(`${o}/characters/profile-picture-set/${e}`);if(!t.ok)throw Error(i(await t.json().catch(()=>({})),"Failed to get profile picture job result"));return t.json()}async function h(e,t,r){let{jobId:a,allJobIds:o,jobPositions:i}=await d(e);return i&&i.length>0&&o&&o.length>0?(p(o,i,t,r).catch(e=>{console.error("Background polling error:",e),t&&t("failed",e instanceof Error?e.message:"Background polling failed")}),{jobIds:o,jobPositions:i}):(l(a,e=>g(e,o),t).then(e=>{e.images&&e.images.length>0&&r&&e.images.forEach(e=>{r(e,e.positionId||"",e.positionName||"")})}).catch(e=>{console.error("Background polling error:",e),t&&t("failed",e instanceof Error?e.message:"Background polling failed")}),{jobIds:o||[a],jobPositions:[]})}async function p(e,t,r,a){let o=[],i=new Set(e),n=Date.now();for(;i.size>0&&Date.now()-n<6e5;){let n=Array.from(i).map(async e=>{try{let t=await m(e);return{jobId:e,result:t}}catch(t){return console.error(`Failed to poll job ${e}:`,t),{jobId:e,result:null}}});for(let{jobId:e,result:s}of(await Promise.all(n)))if(s){if("completed"===s.status&&s.images&&s.images.length>0){let r=t.find(t=>t.jobId===e);r&&s.images.forEach(e=>{let t={...e,positionId:r.positionId,positionName:r.positionName,prompt:r.prompt,negativePrompt:r.negativePrompt};o.push(t),a&&a(t,r.positionId,r.positionName)}),i.delete(e)}else("failed"===s.status||"completed"===s.status&&(!s.images||0===s.images.length))&&(i.delete(e),r&&s.error&&r("failed",s.error))}r&&r(o.length===e.length?"completed":"in_progress"),i.size>0&&await new Promise(e=>setTimeout(e,2e3))}return i.size>0&&console.warn(`Some profile picture jobs timed out: ${Array.from(i).join(", ")}`),o}async function w(e){let t=await (0,a.SH)(`${o}/characters/train-lora`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw Error((await t.json().catch(()=>({}))).message||`Failed to start LoRA training: ${t.status}`);return t.json()}},237:function(e,t,r){r.d(t,{m:function(){return o}});var a=r(63609);function o(){let{data:e,isLoading:t,error:r,refetch:o}=a.SX.subscription.getCurrent.useQuery(void 0,{refetchInterval:6e4,placeholderData:e=>e}),i=e?.tier??"free";return{tier:i,status:e?.status??"active",currentPeriodStart:e?.currentPeriodStart,currentPeriodEnd:e?.currentPeriodEnd,cancelAtPeriodEnd:e?.cancelAtPeriodEnd??!1,isPro:"pro"===i||"unlimited"===i,isStarter:"starter"===i,isFree:"free"===i,isPaid:"free"!==i,isLoading:t,error:r,refetch:o}}}}]);