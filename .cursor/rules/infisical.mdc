---
description: Infisical secrets management patterns and usage guidelines
globs: ["**/*.ts", "**/*.tsx", "**/.env*", "**/mcp.json*", "**/package.json"]
alwaysApply: true
---

# Infisical Secrets Management

## ⚠️ CRITICAL: RYLA Secrets Management

**RYLA uses Infisical for ALL secrets. Never:**
- ❌ Create or modify `.env` files directly
- ❌ Hardcode secrets in code
- ❌ Use `process.env` without Infisical injection
- ❌ Commit secrets to git

**Always:**
- ✅ Use `infisical run` to inject secrets when running apps
- ✅ Use `infisical secrets set` to add/update secrets
- ✅ Access secrets via `process.env` (after Infisical injection)
- ✅ Export to `.env` only for IDE autocomplete (gitignored)

RYLA uses Infisical for centralized secrets management with hierarchical folder structure, role-based access control (RBAC), environment separation (dev/staging/prod), and machine identities for automated systems.

## Secrets Structure

```
RYLA Project
├── /mcp          # MCP server secrets
├── /apps/api     # Backend API secrets
├── /apps/web     # Web app secrets
├── /apps/funnel  # Funnel app secrets
├── /apps/landing # Landing page secrets
├── /shared       # Shared across all apps
├── /logins       # SaaS tool login credentials (emails, passwords, OAuth info)
└── /test         # Test fixtures and credentials
```

## Requirements

### Running Applications

**Always use Infisical to inject secrets:**

```bash
# ✅ Good: Use infisical run
infisical run --path=/apps/api --path=/shared --env=dev -- pnpm nx serve api

# ❌ Bad: Hardcoded secrets or manual .env management
DATABASE_URL=xxx pnpm nx serve api
```

### Environment Variables in Code

**Access via `process.env` as normal:**

```typescript
// ✅ Good: Standard env access (Infisical injects at runtime)
const dbUrl = process.env.DATABASE_URL;

// ✅ Good: With validation
const config = {
  port: Number(process.env.APP_PORT) || 3001,
  dbUrl: process.env.DATABASE_URL || throwError('DATABASE_URL required'),
};
```

### Never Commit Secrets

```bash
# ✅ Good: Export to gitignored .env for IDE support
infisical export --path=/apps/api --path=/shared --env=dev > apps/api/.env

# ❌ Bad: Committing .env files
git add apps/api/.env  # NEVER DO THIS
```

## MCP Server Configuration

### Recommended: CLI Wrapper

```json
{
  "mcpServers": {
    "ryla-api": {
      "command": "infisical",
      "args": [
        "run",
        "--path=/mcp",
        "--env=dev",
        "--",
        "npx", "tsx", "apps/mcp/src/main.ts"
      ]
    },
    "github": {
      "command": "infisical",
      "args": [
        "run",
        "--path=/mcp",
        "--env=dev",
        "--",
        "npx", "-y", "@modelcontextprotocol/server-github"
      ]
    }
  }
}
```

### Alternative: Machine Identity Token

```json
{
  "mcpServers": {
    "ryla-api": {
      "command": "npx",
      "args": ["tsx", "apps/mcp/src/main.ts"],
      "env": {
        "INFISICAL_TOKEN": "${INFISICAL_TOKEN}"
      }
    }
  }
}
```

## Common Commands

### View Secrets

```bash
# List secrets in a folder
infisical secrets --path=/mcp --env=dev

# Get specific secret value
infisical secrets get GITHUB_TOKEN --path=/mcp --env=dev
```

### Set Secrets

```bash
# Set single secret
infisical secrets set API_KEY=xxx --path=/apps/api --env=dev

# Import from .env file
infisical secrets set --path=/apps/api --env=dev < apps/api/.env
```

### Export Secrets

```bash
# Export to .env format
infisical export --path=/apps/api --path=/shared --env=dev > apps/api/.env

# Export as JSON
infisical export --format=json --path=/apps/api --env=dev
```

### Run with Secrets

```bash
# Inject and run command
infisical run --path=/apps/api --path=/shared --env=dev -- npm start

# Multiple paths
infisical run --path=/apps/web --path=/shared --env=dev -- pnpm nx serve web
```

## Folder Assignments

| Application | Paths | Command |
|-------------|-------|---------|
| `apps/api` | `/apps/api`, `/shared` | `infisical run --path=/apps/api --path=/shared` |
| `apps/web` | `/apps/web`, `/shared` | `infisical run --path=/apps/web --path=/shared` |
| `apps/funnel` | `/apps/funnel`, `/shared` | `infisical run --path=/apps/funnel --path=/shared` |
| `apps/landing` | `/apps/landing`, `/shared` | `infisical run --path=/apps/landing --path=/shared` |
| `apps/mcp` | `/mcp` | `infisical run --path=/mcp` |

## Adding New Secrets

### When adding a new secret:

1. **Determine the correct path:**
   - MCP-only → `/mcp`
   - App-specific → `/apps/{app-name}`
   - Shared across apps → `/shared`
   - SaaS tool logins → `/logins` (emails, passwords, OAuth credentials)
   - Test fixtures → `/test`

2. **Add to all environments:**
   ```bash
   infisical secrets set NEW_SECRET=dev_value --path=/apps/api --env=dev
   infisical secrets set NEW_SECRET=staging_value --path=/apps/api --env=staging
   infisical secrets set NEW_SECRET=prod_value --path=/apps/api --env=prod
   ```

3. **Update documentation if needed:**
   - Add to `docs/technical/INFISICAL-SETUP.md` structure diagram
   - Update `.env.example` files for reference

### SaaS Tool Logins (`/logins`)

**Use `/logins` for storing credentials for external SaaS tools and services.**

**Naming Convention:**
- `{SERVICE}_EMAIL` - Email/username for the service
- `{SERVICE}_PASSWORD` - Password (if applicable)
- `{SERVICE}_AUTH_METHOD` - Authentication method (e.g., `oauth_google`, `password`)
- `{SERVICE}_API_KEY` - API key/token for programmatic access
- `{SERVICE}_URL` - Service URL (optional, for reference)
- `{SERVICE}_NOTES` - Additional notes (optional)

**Examples:**
```bash
# OAuth-based services (Google, GitHub, etc.)
infisical secrets set RUNPOD_EMAIL=user@example.com --path=/logins --env=dev
infisical secrets set RUNPOD_AUTH_METHOD=oauth_google --path=/logins --env=dev
infisical secrets set RUNPOD_API_KEY=xxx --path=/logins --env=dev

# Password-based services
infisical secrets set HIGGSFIELD_EMAIL=user@example.com --path=/logins --env=dev
infisical secrets set HIGGSFIELD_PASSWORD=xxx --path=/logins --env=dev
infisical secrets set HIGGSFIELD_URL=https://higgsfield.ai/ --path=/logins --env=dev
```

**Current services in `/logins`:**
- RunPod (OAuth Google)
- Modal (OAuth Google)
- Replicate (OAuth Google)
- Higgsfield (Password)
- HuggingFace (API Token)

## CI/CD Integration

### GitHub Actions

```yaml
- name: Build with secrets
  env:
    INFISICAL_TOKEN: ${{ secrets.INFISICAL_TOKEN }}
  run: |
    infisical run --path=/apps/api --path=/shared --env=prod -- npm run build
```

### Fly.io

```bash
# Set token as Fly secret
fly secrets set INFISICAL_TOKEN=$(infisical machine-identity get-token --name="fly-prod")
```

## ⚠️ CRITICAL: Multiple --path Flag Behavior

**When using multiple `--path` flags, Infisical CLI only uses the LAST path, not all paths combined.**

```bash
# ❌ WRONG: Only /shared secrets are loaded (second path wins)
infisical run --path=/apps/web --path=/shared --env=dev -- npm start
# Result: Secrets from /apps/web are IGNORED

# ❌ WRONG: Only /apps/web secrets are loaded
infisical run --path=/shared --path=/apps/web --env=dev -- npm start
# Result: Secrets from /shared are IGNORED
```

**Solution: Put shared secrets in `/shared` path**

Since commands like `dev:web` use `--path=/apps/web --path=/shared`, any secret needed by web MUST be in `/shared` (the last path).

**Secrets that MUST be in `/shared`:**
- `JWT_ACCESS_SECRET` - Used by web, api, and other apps for token verification
- `JWT_REFRESH_SECRET` - Used for refresh token verification
- Any secret needed by multiple apps

**When adding new secrets:**
1. If the secret is app-specific AND not needed elsewhere → put in `/apps/{app-name}`
2. If the secret is needed by multiple apps OR used with multi-path commands → put in `/shared`

**Debugging missing secrets:**
```bash
# Check what secrets are actually exported with multiple paths
infisical export --path=/apps/web --path=/shared --env=dev

# If a secret is missing, check which path it's in
infisical secrets --path=/apps/web --env=dev | grep SECRET_NAME
infisical secrets --path=/shared --env=dev | grep SECRET_NAME

# Move secret to /shared if needed
infisical secrets set SECRET_NAME='value' --path=/shared --env=dev
```

## Best Practices

1. **Put shared secrets in `/shared`** - Any secret used by multiple apps or in multi-path commands MUST be in `/shared`
2. **Use narrowest scope** - Only request paths you need
3. **Never hardcode secrets** - Always use environment variables
4. **Use machine identities** - For MCP servers and CI/CD
5. **Don't log secrets** - Never `console.log(process.env.SECRET)`
6. **Rotate regularly** - Especially after team changes
7. **Use correct environment** - `dev` for local, `staging` for testing, `prod` for production
8. **Test secret injection** - After changes, verify secrets load: `infisical run --path=... -- sh -c 'echo $SECRET_NAME'`

## Troubleshooting

### Not logged in

```bash
infisical login
```

### Permission denied

Contact admin to grant access to required path/environment.

### Token expired

```bash
# Personal token
infisical login

# Machine identity
infisical machine-identity rotate-token --name="mcp-server"
```

### Secrets not loading

1. Check you're using correct path: `infisical secrets --path=/your/path --env=dev`
2. Verify login: `infisical whoami`
3. Check project init: `cat .infisical.json`

### Secret missing with multiple --path flags

**Symptom:** App logs show "JWT_ACCESS_SECRET not set" or similar, falling back to default values.

**Cause:** Multiple `--path` flags only use the LAST path. Secrets from earlier paths are ignored.

**Solution:**
```bash
# 1. Check which path the secret is in
infisical secrets --path=/apps/web --env=dev | grep JWT_ACCESS_SECRET
infisical secrets --path=/shared --env=dev | grep JWT_ACCESS_SECRET

# 2. If secret is only in /apps/web but command uses --path=/apps/web --path=/shared,
#    the secret won't be loaded. Move it to /shared:
infisical secrets set JWT_ACCESS_SECRET='your-value' --path=/shared --env=dev

# 3. Verify it works
infisical run --path=/apps/web --path=/shared --env=dev -- sh -c 'echo $JWT_ACCESS_SECRET'

# 4. Restart your dev server
```

See the "CRITICAL: Multiple --path Flag Behavior" section above for full details.

## Related Documentation

- Full Setup Guide: `docs/technical/INFISICAL-SETUP.md`
- Environment Variables: `environment-variables.mdc`
- Security: `security.mdc`
